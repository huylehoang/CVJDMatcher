# ðŸ“˜ iOS Developer Guide â€“ Core ML + Custom AI Model Conversion (CVJDMatcher Project)

This guide is for iOS Developers who are **new to Core ML and AI**, and want to build **offline AI features** into their iOS apps using **HuggingFace models** converted to Core ML.

It is based on real work from the **CVJDMatcher** project which demonstrates:
- JD/CV string â†’ embedding vector
- Cosine similarity â†’ top match
- Explanation using local LLM (Core ML reasoning model)

---

## ðŸ“š Table of Contents

- [ðŸ§  What is Core ML?](#-what-is-core-ml)
- [ðŸ§± Typical Workflow](#-typical-workflow)
- [ðŸŽ¯ Good Use Cases](#-good-use-cases)
- [ðŸ› ï¸ Real Example: CV to JD Matching App](#ï¸-real-example-cv-to-jd-matching-app)
- [ðŸ”§ Convert Custom HuggingFace Models](#-convert-custom-huggingface-models)
- [ðŸ§ª Setup Python + Convert Models](#-setup-python--convert-models)
- [ðŸ“¦ Integrate Core ML into Xcode](#-integrate-core-ml-into-xcode)
- [ðŸš€ SwiftUI + Clean Architecture Setup](#-swiftui--clean-architecture-setup)
- [ðŸ“Œ Notes](#-notes)

---

## ðŸ§  What is Core ML?

**Core ML** is Appleâ€™s machine learning  framework to run pre-trained models **on-device** without requiring internet.

| Format         | Description                                                  |
|----------------|--------------------------------------------------------------|
| `.mlmodel`     | Source model used during development (text format)           |
| `.mlpackage`   | Directory-based format (preferred for ML Program support)    |
| `.mlmodelc`    | Compiled binary format generated by Xcode at build time      |
| `MLModel`      | Swift API to interact with models in code                    |

---

## ðŸ§± Typical Workflow

1. âœ… Download model from HuggingFace
2. ðŸ” Convert to `.mlpackage` via `coremltools`
3. ðŸ“¦ Add to Xcode as `Compile Sources`
4. ðŸš€ Use `MLModel(contentsOf:)` in Swift
5. ðŸ§  Run offline predictions with `MLDictionaryFeatureProvider`

---

## ðŸŽ¯ Good Use Cases

| Use Case            | Example Model                     | Output                        |
|---------------------|-----------------------------------|-------------------------------|
| Text Embedding      | `all-MiniLM-L6-v2`                | Vector (e.g., 384-dim)        |
| Text Reasoning      | `distilgpt2`, `gemma`             | Explanations / LLM output     |
| Image Classification| `mobilenet`, `efficientnet`       | Class label                   |

---

## ðŸ› ï¸ Real Example: CV to JD Matching App

### Goal:
1. Embed JD string â†’ vector A
2. Embed multiple CV strings â†’ vector B1, B2, B3...
3. Calculate cosine similarity: `cos(A, Bn)`
4. Return top match
5. Run LLM prompt: "Why does CV match JD?" â†’ Explanation

### Models used:
- ðŸ”· Embedding: `EmbeddingModel.mlpackage` (MiniLM)
- ðŸ”¶ Reasoning: `ReasoningModel.mlpackage` (GPT2 / distilgpt2)

---

## ðŸ”§ Convert Custom HuggingFace Models

Use Python + `coremltools` to convert any HuggingFace model into Core ML:

```python
import torch
import coremltools as ct

# Example model
class MyModel(torch.nn.Module):
    def forward(self, x):
        return x * 2

model = MyModel()
traced = torch.jit.trace(model, torch.randn(1, 10))

# Convert to Core ML
mlmodel = ct.convert(traced, convert_to="mlprogram", source="pytorch")
mlmodel.save("MyModel.mlpackage")
```

**Notes:**
- Only tensors are supported
- No Python control flow (e.g., loops/conditionals) inside model

---

## ðŸ§ª Setup Python + Convert Models

### Folder: `CoreMLTools/`

Scripts:
- `setup_env.sh`: installs virtualenv, torch, transformers, coremltools
- `download_and_convert_embedding_model.py`: converts MiniLM â†’ `EmbeddingModel.mlpackage`
- `download_and_convert_reasoning_model.py`: converts distilgpt2 â†’ `ReasoningModel.mlpackage`

### Run Once:

```bash
cd CoreMLTools
chmod +x setup_env.sh
./setup_env.sh
```

This will:
- Download & trace HuggingFace models
- Output `.mlpackage` into `CVJDMatcher/CoreMLModels/`
- Clean up venv after success

---

## ðŸ“¦ Integrate Core ML into Xcode

1. Move `.mlpackage` to:
```
CVJDMatcher/
â””â”€â”€ CVJDMatcher/
    â””â”€â”€ CoreMLModels/
        â”œâ”€â”€ EmbeddingModel.mlpackage
        â””â”€â”€ ReasoningModel.mlpackage
```

2. In **Xcode > Build Phases > Compile Sources**, add:
```
CoreMLModels/EmbeddingModel.mlpackage
CoreMLModels/ReasoningModel.mlpackage
```

> â— Do NOT add to "Copy Bundle Resources". It causes **duplicate task** error.

3. At runtime, use:
```swift
let url = Bundle.main.url(forResource: "EmbeddingModel", withExtension: "mlmodelc")
let model = try MLModel(contentsOf: url!)
```

---

## ðŸš€ SwiftUI + Clean Architecture Setup

### Folder Layout:
```
CVJDMatcher/
â”œâ”€â”€ Content/
â”‚   â”œâ”€â”€ ContentView.swift
â”‚   â”œâ”€â”€ ContentViewModel.swift
â”‚   â””â”€â”€ MatchResult.swift
â”‚
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ EmbeddingService.swift
â”‚   â””â”€â”€ ReasoningService.swift
â”‚
â”œâ”€â”€ CoreMLModels/
â”‚   â”œâ”€â”€ EmbeddingModel.mlpackage
â”‚   â””â”€â”€ ReasoningModel.mlpackage
```

### ViewModel (excerpt):
```swift
@MainActor
final class ContentViewModel: ObservableObject {
    @Published var matchResults: [MatchResult] = []

    func runMatchingFlow() {
        Task {
            try embedding.loadModel()
            try reasoning.loadModel()

            let results = try await Task.detached { [weak self] in
                guard let self else { return [] }
                let jdVec = try self.embedding.embed(self.jd)
                return self.cvs.map {
                    let cvVec = try self.embedding.embed($0)
                    let score = self.cosine(jdVec, cvVec)
                    let explanation = try self.reasoning.explain(jd: self.jd, cv: $0)
                    return MatchResult(cv: $0, score: score, explanation: explanation)
                }
            }.value

            self.matchResults = results
        }
    }
}
```

---

## ðŸ“Œ Notes

- `.mlpackage` is auto-compiled to `.mlmodelc` at build time
- `Task.detached` = run off main thread (no UI freeze)
- Avoid string inputs to traced model â†’ use token IDs
- Use `@MainActor` on ViewModel to sync UI updates
- Use `FileManager.default.contentsOfDirectory` to debug model loading if needed

---

> âœ… Youâ€™ve now built an iOS SwiftUI app that does **offline AI reasoning** using HuggingFace + Core ML.

Happy learning & building! ðŸ’¡ðŸš€
