# 📘 iOS Developer Guide – Core ML + Custom AI Model Conversion (CVJDMatcher Project)

This guide is for iOS Developers who are **new to Core ML and AI**, and want to build **offline AI features** into their iOS apps using **HuggingFace models** converted to Core ML.

It is based on real work from the **CVJDMatcher** project which demonstrates:
- JD/CV string → embedding vector
- Cosine similarity → top match
- Explanation using local LLM (Core ML reasoning model)

---

## 📚 Table of Contents

- [🧠 What is Core ML?](#-what-is-core-ml)
- [🧱 Typical Workflow](#-typical-workflow)
- [🎯 Good Use Cases](#-good-use-cases)
- [🛠️ Real Example: CV to JD Matching App](#️-real-example-cv-to-jd-matching-app)
- [🔧 Convert Custom HuggingFace Models](#-convert-custom-huggingface-models)
- [🧪 Setup Python + Convert Models](#-setup-python--convert-models)
- [📦 Integrate Core ML into Xcode](#-integrate-core-ml-into-xcode)
- [🚀 SwiftUI + Clean Architecture Setup](#-swiftui--clean-architecture-setup)
- [📌 Notes](#-notes)

---

## 🧠 What is Core ML?

**Core ML** is Apple’s machine learning  framework to run pre-trained models **on-device** without requiring internet.

| Format         | Description                                                  |
|----------------|--------------------------------------------------------------|
| `.mlmodel`     | Source model used during development (text format)           |
| `.mlpackage`   | Directory-based format (preferred for ML Program support)    |
| `.mlmodelc`    | Compiled binary format generated by Xcode at build time      |
| `MLModel`      | Swift API to interact with models in code                    |

---

## 🧱 Typical Workflow

1. ✅ Download model from HuggingFace
2. 🔁 Convert to `.mlpackage` via `coremltools`
3. 📦 Add to Xcode as `Compile Sources`
4. 🚀 Use `MLModel(contentsOf:)` in Swift
5. 🧠 Run offline predictions with `MLDictionaryFeatureProvider`

---

## 🎯 Good Use Cases

| Use Case            | Example Model                     | Output                        |
|---------------------|-----------------------------------|-------------------------------|
| Text Embedding      | `all-MiniLM-L6-v2`                | Vector (e.g., 384-dim)        |
| Text Reasoning      | `distilgpt2`, `gemma`             | Explanations / LLM output     |
| Image Classification| `mobilenet`, `efficientnet`       | Class label                   |

---

## 🛠️ Real Example: CV to JD Matching App

### Goal:
1. Embed JD string → vector A
2. Embed multiple CV strings → vector B1, B2, B3...
3. Calculate cosine similarity: `cos(A, Bn)`
4. Return top match
5. Run LLM prompt: "Why does CV match JD?" → Explanation

### Models used:
- 🔷 Embedding: `EmbeddingModel.mlpackage` (MiniLM)
- 🔶 Reasoning: `ReasoningModel.mlpackage` (GPT2 / distilgpt2)

---

## 🔧 Convert Custom HuggingFace Models

Use Python + `coremltools` to convert any HuggingFace model into Core ML:

```python
import torch
import coremltools as ct

# Example model
class MyModel(torch.nn.Module):
    def forward(self, x):
        return x * 2

model = MyModel()
traced = torch.jit.trace(model, torch.randn(1, 10))

# Convert to Core ML
mlmodel = ct.convert(traced, convert_to="mlprogram", source="pytorch")
mlmodel.save("MyModel.mlpackage")
```

**Notes:**
- Only tensors are supported
- No Python control flow (e.g., loops/conditionals) inside model

---

## 🧪 Setup Python + Convert Models

### Folder: `CoreMLTools/`

Scripts:
- `setup_env.sh`: installs virtualenv, torch, transformers, coremltools
- `download_and_convert_embedding_model.py`: converts MiniLM → `EmbeddingModel.mlpackage`
- `download_and_convert_reasoning_model.py`: converts distilgpt2 → `ReasoningModel.mlpackage`

### Run Once:

```bash
cd CoreMLTools
chmod +x setup_env.sh
./setup_env.sh
```

This will:
- Download & trace HuggingFace models
- Output `.mlpackage` into `CVJDMatcher/CoreMLModels/`
- Clean up venv after success

---

## 📦 Integrate Core ML into Xcode

1. Move `.mlpackage` to:
```
CVJDMatcher/
└── CVJDMatcher/
    └── CoreMLModels/
        ├── EmbeddingModel.mlpackage
        └── ReasoningModel.mlpackage
```

2. In **Xcode > Build Phases > Compile Sources**, add:
```
CoreMLModels/EmbeddingModel.mlpackage
CoreMLModels/ReasoningModel.mlpackage
```

> ❗ Do NOT add to "Copy Bundle Resources". It causes **duplicate task** error.

3. At runtime, use:
```swift
let url = Bundle.main.url(forResource: "EmbeddingModel", withExtension: "mlmodelc")
let model = try MLModel(contentsOf: url!)
```

---

## 🚀 SwiftUI + Clean Architecture Setup

### Folder Layout:
```
CVJDMatcher/
├── Content/
│   ├── ContentView.swift
│   ├── ContentViewModel.swift
│   └── MatchResult.swift
│
├── Services/
│   ├── EmbeddingService.swift
│   └── ReasoningService.swift
│
├── CoreMLModels/
│   ├── EmbeddingModel.mlpackage
│   └── ReasoningModel.mlpackage
```

### ViewModel (excerpt):
```swift
@MainActor
final class ContentViewModel: ObservableObject {
    @Published var matchResults: [MatchResult] = []

    func runMatchingFlow() {
        Task {
            try embedding.loadModel()
            try reasoning.loadModel()

            let results = try await Task.detached { [weak self] in
                guard let self else { return [] }
                let jdVec = try self.embedding.embed(self.jd)
                return self.cvs.map {
                    let cvVec = try self.embedding.embed($0)
                    let score = self.cosine(jdVec, cvVec)
                    let explanation = try self.reasoning.explain(jd: self.jd, cv: $0)
                    return MatchResult(cv: $0, score: score, explanation: explanation)
                }
            }.value

            self.matchResults = results
        }
    }
}
```

---

## 📌 Notes

- `.mlpackage` is auto-compiled to `.mlmodelc` at build time
- `Task.detached` = run off main thread (no UI freeze)
- Avoid string inputs to traced model → use token IDs
- Use `@MainActor` on ViewModel to sync UI updates
- Use `FileManager.default.contentsOfDirectory` to debug model loading if needed

---

> ✅ You’ve now built an iOS SwiftUI app that does **offline AI reasoning** using HuggingFace + Core ML.

Happy learning & building! 💡🚀
